set nocompatible
filetype off

" Filetypes
augroup filetypedetect
    au BufRead,BufNewFile *.hbs setfiletype html
augroup END
augroup filetypedetect
    au BufRead,BufNewFile *.sig setfiletype sml
augroup END
" plug
call plug#begin()
Plug 'chriskempson/base16-vim'
Plug 'rust-lang/rust.vim'
Plug 'flazz/vim-colorschemes'
Plug 'scrooloose/nerdtree'
Plug 'ervandew/supertab'
Plug 'moll/vim-bbye'
Plug 'tpope/vim-commentary'
Plug 'alessandroyorba/alduin'
Plug 'Chiel92/vim-autoformat'
Plug 'tpope/vim-surround'
Plug 'pangloss/vim-javascript'
Plug 'ctrlpvim/ctrlp.vim'
Plug 'junegunn/vim-easy-align'
Plug 'leafgarland/typescript-vim'
Plug 'w0rp/ale'
Plug 'StanAngeloff/php.vim'
Plug 'vim-scripts/jcommenter.vim'
call plug#end()

filetype plugin indent on
runtime ftplugin/man.vim

" Spell checking
set spelllang=en

" Backup files are annoying
set nobackup
set nowritebackup
set noswapfile

" history
set history=700

" Vim recommended
if has('autocmd')
  filetype plugin indent on
endif
if has('syntax') && !exists('g:syntax_on')
  syntax enable
endif
set synmaxcol=9999
set hidden " Allows you to switch buffers without saving current
set wildmenu
set wildmode=longest:full,full " First tab brings up options, second tab cycles
set encoding=utf8

" Movement
let mapleader = ","
set tm=2000
noremap ,, ,
set pastetoggle=<F11>

" treat wrapped lines as different lines
nnoremap j gj
nnoremap k gk

" Enable mouse support
set mouse=a

" Set 7 lines to the cursor - when moving vertically using j/k
set so=7

" Always show current position
set ruler

" Playing around with having these off
" set number
" set cursorcolumn
" set cursorline


" Remove bell
set visualbell
set t_vb=

" Better searching
set incsearch
set ignorecase
set smartcase
set wrapscan "wraps around end of file
" Redraw screen and clear highlighting
nnoremap <Leader>r :nohl<CR><C-L>

" Don't redraw while executing macros (good performance config)
set lazyredraw

" tabs
set expandtab
set smarttab

" show whitespace
set list

" nowrap
set nowrap

" Show matching bracket
set showmatch
set matchtime=2
set shiftwidth=2
set tabstop=2

" But only interesting whitespace
if &listchars ==# 'eol:$'
  set listchars=tab:>\ ,trail:-,extends:>,precedes:<,nbsp:+
endif

" Configure backspace so it acts as it should act
set backspace=eol,start,indent
set whichwrap+=<,>,h,l

" Return to last edit position when opening files (You want this!)
augroup last_edit
  autocmd!
  autocmd BufReadPost *
       \ if line("'\"") > 0 && line("'\"") <= line("$") |
       \   exe "normal! g`\"" |
       \ endif
augroup END

" previous buffer, next buffer
nnoremap <leader>bp :bp<cr>
nnoremap <leader>bn :bn<cr>

" delete buffer without closing pane
noremap <leader>bd :Bd<cr>

" Close nerdtree after a file is selected
let NERDTreeQuitOnOpen = 1

function! IsNERDTreeOpen()
  return exists("t:NERDTreeBufName") && (bufwinnr(t:NERDTreeBufName) != -1)
endfunction

function! ToggleFindNerd()
  if IsNERDTreeOpen()
    exec ':NERDTreeToggle'
  else
    exec ':NERDTreeFind'
  endif
endfunction

function! Json()
  :%!jq --sort-keys .
endfunction

" CtrlP using ripgrep
if executable('rg')
  set grepprg=rg\ --color=never
  let g:ctrlp_user_command = 'rg %s --files --color=never --glob ""'
  let g:ctrlp_use_caching = 0
endif

" If nerd tree is closed, find current file, if open, close it
nmap <silent> <leader>f <ESC>:call ToggleFindNerd()<CR>
nmap <silent> <leader>F <ESC>:NERDTreeToggle<CR>

" Start interactive EasyAlign in visual mode (e.g. vipga)
xmap ga <Plug>(EasyAlign)

" Start interactive EasyAlign for a motion/text object (e.g. gaip)
nmap ga <Plug>(EasyAlign)

" base16, uncomment when installed
let base16colorspace=256
set termguicolors
colorscheme base16-twilight
highlight StatusLineNC gui=underline cterm=underline guibg=#1e1e1e
highlight StatusLine gui=underline cterm=underline guibg=#1e1e1e
highlight SignColumn guibg=#1e1e1e guifg=#1e1e1e
highlight VertSplit guibg=#1e1e1e
highlight Cursorline cterm=underline guibg=#1e1e1e
highlight TabLine guibg=#1e1e1e cterm=none
highlight TabLineFill guifg=#a7a7a7
highlight TabLineSel guibg=#a7a7a7 cterm=bold

set statusline=%f\ %h%w%m%r\ %=%(%l,%c%V\ %=\ %P%)

function ClearWhitespace()
  %s/\s\+$//e
endfunction

function Lambda()
  %s/lambda/Î»/ge
endfunction

nnoremap <Leader>w :call ClearWhitespace()<CR>
nnoremap <Leader>L :call Lambda()<CR>

" Ale syntax checking
let g:ale_rust_cargo_use_check = 1
" Save battery by only running on saving/entering files
let g:ale_lint_on_text_changed = 'never'
nmap <silent> <C-k> <Plug>(ale_previous_wrap)
nmap <silent> <C-j> <Plug>(ale_next_wrap)
nmap <silent> <C-l> :tabn<CR>
nmap <silent> <C-h> :tabp<CR>


" Pane movement/organization
noremap <Leader>h <C-W>h
noremap <Leader>j <C-W>j
noremap <Leader>k <C-W>k
noremap <Leader>l <C-W>l

noremap <Leader>H <C-W>H
noremap <Leader>J <C-W>J
noremap <Leader>K <C-W>K
noremap <Leader>L <C-W>L

noremap <Leader>p <C-W>p
noremap <Leader>T <C-W>T
noremap <Leader><C-R> <C-W><C-R>
set termkey=,

" Digraphs
digraph C! 8713
digraph !C 8716
digraph E* 400
digraph is 7522
digraph ks 8342
digraph ns 8345
digraph ls 8343
digraph ms 8344
digraph rs 5384

" Jcommenter config
noremap <Leader>c :call JCommentWriter() <bar> call ClearWhitespace()<CR><ESC>

autocmd InsertEnter,InsertLeave * set cul!
